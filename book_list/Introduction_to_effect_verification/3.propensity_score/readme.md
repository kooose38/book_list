# 傾向スコア

## 概要

- 傾向スコアとは、各サンプルにおいて介入が行われる確率のこと。共変量を使って推定された確率である。
- 介入が行われた仕組み（本来は施策に有利な介入を行う）に着目して、介入グループと日介入グループの性質を近くする操作を行うことで、これらの問題を回避すること。
- 傾向スコアの推定方法として、多くの場合でロジスティクス回帰が使用される。

## マッチング

- 介入が行われているグループからサンプルを取り出し、そのサンプルに近似する傾向スコアのさんぷるを非介入グループから取り出してマッチングする。そのペアで目的変数（効果量）の差を算出して、平均をとったもので効果量を推定する。つまり、**非介入グループに介入グループと同じような特性を持ったサンプルが存在すると考えられる場合に有効的。**
- 同傾向スコア帯におけるサンプルでは、介入変数Zは目的変数Yとは独立で決まる。グループ間で比較してもセレクションバイアスを受けない。
- マッチングする数は、通常は介入・非介入のサンプルサイズが小さいほうに合わせる。介入のほうが何かしらの施策が入っているため、サンプルサイズが小さくなりがちな印象。
- 考え方はシンプルだが、推定までの時間がかかる。

```
    # Zを介入したかどうか、Xを共変量とする。
    Z = αX + β

    # 効果量の算出(ATTと呼ばれる。)
    Y = (ある傾向スコアにおける介入グループの効果量) - (同傾向スコア帯における非介入グループの効果量)
```

## 逆確率重みづけ推定：IPW

- 与えられたデータ全体の介入グループの目的変数の期待値と、非介入グループの目的変数の期待値を推定する。本来は、介入なら介入した場合の目的変数、非介入なら非介入した場合の目的変数しか実データから得られない。つまり、介入なら介入していない場合の目的変数（非介入も同様）を推定して、効果量を推定しようというもの。
- つまり本来観測されないはずの効果量を推定して、サンプル数を増やすことで本来の効果量の期待値へと近づける。
- 

```
    # 通常の介入グループの効果量における平均計算に傾向スコアの重みをつけて掲載している
    介入グループの効果量 = ( (介入グループの効果量の合計) / (介入がおこる確率) ) / ((介入グループの個数) / (介入がおこる確率) )

```


## 判断基準
- 多くの場合共変量のバランスがとれているか確認するために、介入・非介入グループの共変量の平均が近い値であるかを確認する。
- マッチングでは、マッチングしたサンプルを使って算出し、IPWでは重みづけされたサンプルを使って算出される。
- 介入を受けたサンプルと介入を受けていないサンプルの各変数の平均にどの程度の差があるか可視化する。傾向スコアによって共変量のバランスがとれている状態を期待するために、平均に差がない状態（各変数が0に近づいている)が理想的であるといえる。

```
    # Rでの実行例
    install.packages('cobalt')
    love.plot(傾向スコア推定の変数, threshold=.1)
```


## 機械学習への活用

- 機械学習への導入が進んでいる環境では、すでに介入する確率(傾向スコア)がデータに残されている場合がある。
- 上記の傾向スコアがなくとも、介入への意思決定する仕組みがヒアリング等で得られる可能性もある。このような場合において、傾向スコアを用いた分析へのモチベーションが高くなる。
- つまり、あるモデルによって目的変数が一定値以上へ介入を行っているデータをそのまま効果検証(介入・非介入の効果量の平均差)をしてしまうと、セレクションバイアスが生まれやすく本来の効果量の推定ができなくなる。傾向スコアが0/1でなくある一定以上の閾値で割り振りされている場合、回帰不連続デザイン(RDD)を用いる。


