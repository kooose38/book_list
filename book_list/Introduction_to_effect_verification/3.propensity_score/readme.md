# 傾向スコア

## 概要

- 傾向スコアとは、各サンプルにおいて介入が行われる確率のこと。共変量を使って推定された確率である。
- 介入が行われた仕組み（本来は施策に有利な介入を行う）に着目して、介入グループと日介入グループの性質を近くする操作を行うことで、これらの問題を回避すること。
- 傾向スコアの推定方法として、多くの場合でロジスティクス回帰が使用される。

## マッチング

- 介入が行われているグループからサンプルを取り出し、そのサンプルに近似する傾向スコアのさんぷるを非介入グループから取り出してマッチングする。そのペアで目的変数（効果量）の差を算出して、平均をとったもので効果量を推定する。
- 同傾向スコア帯におけるサンプルでは、介入変数Zは目的変数Yとは独立で決まる。グループ間で比較してもセレクションバイアスを受けない。
- マッチングする数は、通常は介入・非介入のサンプルサイズが小さいほうに合わせる。介入のほうが何かしらの施策が入っているため、サンプルサイズが小さくなりがちな印象。
- 考え方はシンプルだが、推定までの時間がかかる。

```
    # Zを介入したかどうか、Xを共変量とする。
    Z = αX + β

    # 効果量の算出(ATTと呼ばれる。)
    Y = (ある傾向スコアにおける介入グループの効果量) - (同傾向スコア帯における非介入グループの効果量)
```

## 逆確率重みづけ推定：IPW

- 与えられたデータ全体の介入グループの目的変数の期待値と、非介入グループの目的変数の期待値を推定する。本来は、介入なら介入した場合の目的変数、非介入なら非介入した場合の目的変数しか実データから得られない。つまり、介入なら介入していない場合の目的変数（非介入も同様）を推定して、効果量を推定しようというもの。
- つまり本来観測されないはずの効果量を推定して、サンプル数を増やすことで本来の効果量の期待値へと近づける。
- 

```
    # 通常の介入グループの効果量における平均計算に傾向スコアの重みをつけて掲載している
    介入グループの効果量 = ( (介入グループの効果量の合計) / (介入がおこる確率) ) / ((介入グループの個数) / (介入がおこる確率) )

```


